generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Gym {
  id              String            @id @default(cuid())
  name            String
  logo            String?           @db.Text // Base64 encoded logo image
  settings        Json              @default("{}")
  aiMonthlyBudget Float?            // Monthly AI budget cap in USD (null = unlimited)

  // Subscription fields (B2B - tiered pricing: starter €99, pro €199, elite €299)
  subscribedAt        DateTime?     // When gym subscription was first activated
  subscribedUntil     DateTime?     // When current subscription period ends
  subscriptionStatus  String        @default("pending") // pending | active | grace | expired
  subscriptionTier    String        @default("starter") // starter | pro | elite
  stripeCustomerId    String?       // Stripe customer ID
  stripeSubscriptionId String?      // Stripe subscription ID

  // Branding customization
  primaryColor    String?           // Primary brand color (e.g., #ef4444)
  secondaryColor  String?           // Secondary color

  // Challenge check-in verification
  checkinSecret   String?           // Secret code for gym QR check-in (validates physical presence)

  // Contact info for gym portal
  ownerEmail      String?           // Gym owner email for billing
  ownerName       String?           // Gym owner name
  phone           String?           // Contact phone
  address         String?           // Gym address

  members         Member[]
  staff           Staff[]
  aiUsageMonthly  AIUsageMonthly[]
  customMeals     CustomMeal[]      // Gym-wide shared meals
  savedIngredients SavedIngredient[] // Gym-wide shared ingredients
  challenges      Challenge[]       // Gym challenges/competitions
  gymCheckins     GymCheckin[]      // Member check-ins at the gym
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([subscriptionStatus])
  @@index([stripeCustomerId])
  @@map("gyms")
}

model Member {
  id                  String            @id @default(cuid())
  memberId            String
  pin                 String
  qrCode              String?           @unique
  name                String
  avatarUrl           String?           @db.Text // Base64 encoded avatar image
  height              Float?
  weight              Float?
  gender              String?
  goal                String
  status              String            @default("active")
  locale              String            @default("sr") // sr | en
  hasSeenOnboarding   Boolean           @default(false) // Track if user has seen the "Why This Works" explainer

  // Custom targets (member can set these if they don't have a coach)
  // Priority: CoachAssignment targets > Member custom targets > Auto-calculated
  customCalories      Int?              // Custom daily calorie target
  customProtein       Int?              // Custom protein target (grams)
  customCarbs         Int?              // Custom carbs target (grams)
  customFats          Int?              // Custom fats target (grams)

  // Subscription fields (renewed at gym counter, 5€/month)
  subscribedAt        DateTime?         // When subscription was first activated
  subscribedUntil     DateTime?         // When current subscription period ends
  subscriptionStatus  String            @default("active") // active | expired
  gymId               String
  gym                 Gym               @relation(fields: [gymId], references: [id], onDelete: Cascade)
  dailyLogs           DailyLog[]
  weeklyCheckins      WeeklyCheckin[]
  aiSummaries         AISummary[]
  chatMessages        ChatMessage[]
  coachAssignment     CoachAssignment?  // One member can only have one coach
  coachRequest        CoachRequest?     // Pending coach request (only 1 at a time)
  receivedNudges      CoachNudge[]
  coachKnowledge      CoachKnowledge[]  // Per-member AI knowledge from coach
  customMeals         CustomMeal[]      // Member's saved meals
  savedIngredients    SavedIngredient[] // Member's saved ingredients

  // Dual-role: Staff member linked to this account (for coaches who track their own progress)
  staffAccount        Staff?            @relation("StaffMemberLink")

  // Challenge participations
  challengeParticipations ChallengeParticipant[]
  challengeWins           ChallengeWinner[]

  // Gym check-ins (for challenge verification)
  gymCheckins         GymCheckin[]

  // Week reset - when set, consistency tracking starts from this date instead of createdAt
  weekResetAt         DateTime?

  // Session scheduling
  sessionRequests     SessionRequest[]
  scheduledSessions   ScheduledSession[]

  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  @@unique([memberId, gymId])
  @@index([gymId])
  @@index([status])
  @@index([subscriptionStatus])
  @@map("members")
}

model Staff {
  id                String            @id @default(cuid())
  staffId           String
  pin               String
  name              String
  role              String            // "ADMIN" | "COACH"
  locale            String            @default("sr") // sr | en
  avatarUrl         String?           @db.Text // Base64 encoded avatar image
  bio               String?           @db.Text // Short bio/description for coach profile
  gymId             String
  gym               Gym               @relation(fields: [gymId], references: [id], onDelete: Cascade)

  // Dual-role: Staff can optionally link to a Member account for personal tracking
  linkedMemberId    String?           @unique
  linkedMember      Member?           @relation("StaffMemberLink", fields: [linkedMemberId], references: [id], onDelete: SetNull)

  notes             StaffNote[]
  assignedMembers   CoachAssignment[]
  coachRequests     CoachRequest[]    // Pending coach requests sent by this coach
  nudges            CoachNudge[]
  coachKnowledge    CoachKnowledge[]
  createdMeals      CustomMeal[]      // Meals created by coach for their members

  // Session scheduling
  sessionRequests   SessionRequest[]
  scheduledSessions ScheduledSession[]

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@unique([staffId, gymId])
  @@index([gymId])
  @@map("staff")
}

model DailyLog {
  id                String   @id @default(cuid())
  memberId          String
  member            Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  date              DateTime @default(now())
  type              String
  mealSize          String?
  mealName          String?
  mealPhotoUrl      String?  @db.Text  // Photo from saved meal (base64)
  estimatedCalories Int?
  estimatedProtein  Int?
  estimatedCarbs    Int?
  estimatedFats     Int?
  createdAt         DateTime @default(now())

  @@index([memberId])
  @@index([date])
  @@index([memberId, date])
  @@map("daily_logs")
}

model WeeklyCheckin {
  id         String   @id @default(cuid())
  memberId   String
  member     Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  weight     Float
  feeling    Int
  photoUrl   String?
  weekNumber Int
  year       Int
  createdAt  DateTime @default(now())

  @@unique([memberId, weekNumber, year])
  @@index([memberId])
  @@map("weekly_checkins")
}

model AISummary {
  id        String   @id @default(cuid())
  memberId  String
  member    Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  type      String
  content   String
  date      DateTime
  createdAt DateTime @default(now())

  @@index([memberId])
  @@index([memberId, date])
  @@map("ai_summaries")
}

model StaffNote {
  id        String   @id @default(cuid())
  staffId   String
  staff     Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)
  memberId  String
  content   String
  flags     String[]
  createdAt DateTime @default(now())

  @@index([staffId])
  @@index([memberId])
  @@map("staff_notes")
}

model ChatMessage {
  id        String   @id @default(cuid())
  memberId  String
  member    Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  role      String
  content   String
  agentType String?  // "nutrition" | "supplements" | "training" | null (legacy/general)
  createdAt DateTime @default(now())

  @@index([memberId])
  @@index([memberId, createdAt])
  @@index([memberId, agentType, createdAt])
  @@map("chat_messages")
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  userType  String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
  @@map("sessions")
}

// AI Response Cache - persisted cache for common questions
model AIResponseCache {
  id           String   @id @default(cuid())
  cacheKey     String   @unique // normalized query pattern
  query        String   // original query that created this cache
  response     String   // cached AI response
  hits         Int      @default(1)
  lastUsedAt   DateTime @default(now())
  createdAt    DateTime @default(now())

  @@index([cacheKey])
  @@index([lastUsedAt])
  @@map("ai_response_cache")
}

// AI Usage Tracking - for rate limiting per member per day
model AIUsageDaily {
  id        String   @id @default(cuid())
  memberId  String
  date      DateTime @db.Date // just the date, no time
  count     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([memberId, date])
  @@index([memberId])
  @@index([date])
  @@map("ai_usage_daily")
}

// AI Cost Tracking - monthly usage per gym for budget caps
model AIUsageMonthly {
  id              String   @id @default(cuid())
  gymId           String
  gym             Gym      @relation(fields: [gymId], references: [id], onDelete: Cascade)
  year            Int
  month           Int      // 1-12
  totalRequests   Int      @default(0)
  totalTokensIn   Int      @default(0)
  totalTokensOut  Int      @default(0)
  estimatedCostUsd Float   @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([gymId, year, month])
  @@index([gymId])
  @@map("ai_usage_monthly")
}

// Coach ↔ Member assignment (which coach is responsible for which member)
// One member can only have one coach, but a coach can have many members
model CoachAssignment {
  id             String   @id @default(cuid())
  staffId        String
  memberId       String   @unique // One member can only have one coach
  assignedAt     DateTime @default(now())
  // Coach-set targets (overrides automatic calculations)
  customGoal     String?  // Coach can override member's goal
  customCalories Int?     // Coach-set daily calorie target
  customProtein  Int?     // Coach-set daily protein target (grams)
  customCarbs    Int?     // Coach-set daily carbs target (grams)
  customFats     Int?     // Coach-set daily fats target (grams)
  notes          String?  // Initial notes when assigning
  // Tracking settings
  requireExactMacros Boolean @default(false) // If true, member must enter exact P/C/F for each meal

  staff          Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)
  member         Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([staffId])
  @@index([memberId])
  @@map("coach_assignments")
}

// One-way nudges from coach to member (not chat - just accountability signals)
model CoachNudge {
  id        String    @id @default(cuid())
  staffId   String
  memberId  String
  message   String
  createdAt DateTime  @default(now())
  seenAt    DateTime?

  staff     Staff     @relation(fields: [staffId], references: [id], onDelete: Cascade)
  member    Member    @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([staffId])
  @@index([memberId])
  @@index([memberId, seenAt])
  @@map("coach_nudges")
}

// Coach-specific knowledge that gets injected into AI agent prompts (per member)
model CoachKnowledge {
  id        String   @id @default(cuid())
  staffId   String
  memberId  String   // Knowledge is specific to each member
  agentType String   // "nutrition" | "supplements" | "training"
  content   String   @db.Text // Coach's custom knowledge/instructions

  staff     Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)
  member    Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([staffId, memberId, agentType])
  @@index([staffId])
  @@index([memberId])
  @@map("coach_knowledge")
}

// Pending coach request - can be initiated by coach OR member
// Only 1 pending request per member at a time
model CoachRequest {
  id             String   @id @default(cuid())
  staffId        String
  memberId       String   @unique // Only 1 pending request per member

  // Request direction - who initiated this request
  initiatedBy    String   @default("coach")  // "coach" | "member"

  // Member contact info (for member-initiated requests)
  memberFirstName  String?  // Member's first name
  memberLastName   String?  // Member's last name
  memberPhone      String?  // Member's phone number (required for member-initiated)
  memberMessage    String?  // Optional message to coach

  // Coach-proposed settings (same as CoachAssignment)
  customGoal     String?  // Coach can override member's goal
  customCalories Int?     // Coach-set daily calorie target
  customProtein  Int?     // Coach-set daily protein target (grams)
  customCarbs    Int?     // Coach-set daily carbs target (grams)
  customFats     Int?     // Coach-set daily fats target (grams)
  notes          String?  // Initial notes
  requireExactMacros Boolean @default(false)

  createdAt      DateTime @default(now())

  staff          Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)
  member         Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([staffId])
  @@index([memberId])
  @@map("coach_requests")
}

// Custom meals created by members (with ingredients)
// Can also be created by coaches for their assigned members
model CustomMeal {
  id              String           @id @default(cuid())
  memberId        String
  member          Member           @relation(fields: [memberId], references: [id], onDelete: Cascade)
  gymId           String
  gym             Gym              @relation(fields: [gymId], references: [id], onDelete: Cascade)

  // If set, this meal was created by a coach for the member
  // Member can see and use the meal but cannot edit it
  createdByCoachId String?
  createdByCoach   Staff?           @relation(fields: [createdByCoachId], references: [id], onDelete: SetNull)

  name            String           // Meal name

  // Totals (auto-summed from ingredients OR manual override)
  totalCalories   Int
  totalProtein    Int?
  totalCarbs      Int?
  totalFats       Int?
  isManualTotal   Boolean          @default(false)  // If true, totals were manually set

  // Sharing with gym (requires admin approval)
  isShared           Boolean          @default(false)  // User wants to share with gym
  shareApproved      Boolean          @default(false)  // Admin has approved sharing
  shareRequestedAt   DateTime?        // When user requested to share

  // Meal photo (required for shared meals, optional for private)
  photoUrl           String?          @db.Text  // Base64 encoded image (4:3 landscape, max 1MB)

  ingredients     MealIngredient[]

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([memberId])
  @@index([gymId, isShared, shareApproved])
  @@map("custom_meals")
}

// Saved ingredients library (reusable across meals)
model SavedIngredient {
  id              String           @id @default(cuid())
  memberId        String
  member          Member           @relation(fields: [memberId], references: [id], onDelete: Cascade)
  gymId           String
  gym             Gym              @relation(fields: [gymId], references: [id], onDelete: Cascade)

  name            String           // e.g., "Chicken breast"
  defaultPortion  String           // e.g., "100g", "1 piece"
  calories        Int              // For the default portion
  protein         Int?
  carbs           Int?
  fats            Int?

  isShared        Boolean          @default(false)  // Gym-wide sharing

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([memberId])
  @@index([gymId, isShared])
  @@map("saved_ingredients")
}

// Ingredients within a custom meal
model MealIngredient {
  id                  String            @id @default(cuid())
  mealId              String
  meal                CustomMeal        @relation(fields: [mealId], references: [id], onDelete: Cascade)

  savedIngredientId   String?           // Optional - link to library

  name                String            // Ingredient name (copied or custom)
  portionSize         String            // e.g., "120g", "100ml", "2 pieces"
  calories            Int
  protein             Int?
  carbs               Int?
  fats                Int?

  createdAt           DateTime          @default(now())

  @@index([mealId])
  @@map("meal_ingredients")
}

// Subscription history log - tracks all subscription changes for gyms and members
model SubscriptionLog {
  id              String    @id @default(cuid())

  // Polymorphic - can track gym or member subscriptions
  entityType      String    // "gym" | "member"
  entityId        String    // Gym ID or Member ID

  action          String    // "activated" | "extended" | "expired" | "payment_received" | "grace_started"
  previousEndDate DateTime?
  newEndDate      DateTime?
  months          Int?      // Number of months added
  amount          Float?    // Payment amount (150€ for gym, 5€ for member)
  notes           String?

  // Who made the change
  performedBy     String?   // Staff ID who made the change (null for automated/Stripe)
  performedByType String?   // "staff" | "system" | "stripe"

  createdAt       DateTime  @default(now())

  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("subscription_logs")
}

// Gym challenges/competitions - gamification for member engagement
model Challenge {
  id                String   @id @default(cuid())
  gymId             String
  gym               Gym      @relation(fields: [gymId], references: [id], onDelete: Cascade)

  // Basic info
  name              String
  description       String   @db.Text
  rewardDescription String   @db.Text

  // Dates
  startDate         DateTime
  endDate           DateTime
  joinDeadlineDays  Int      @default(7) // Days after start when registration closes

  // Configuration
  winnerCount       Int      @default(3)  // Top N winners
  status            String   @default("draft") // draft | registration | active | ended

  // Point configuration (admin can customize per challenge)
  pointsPerMeal     Int      @default(5)
  pointsPerTraining Int      @default(15)
  pointsPerWater    Int      @default(1)
  pointsPerCheckin  Int      @default(25)
  streakBonus       Int      @default(5)   // Daily streak bonus

  // Winner exclusion settings
  excludeTopN          Int   @default(3)   // Top N winners are excluded from future challenges
  winnerCooldownMonths Int   @default(3)   // Months until winners can participate again

  participants      ChallengeParticipant[]
  winners           ChallengeWinner[]

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([gymId])
  @@index([gymId, status])
  @@index([startDate, endDate])
  @@map("challenges")
}

// Challenge participant - tracks member enrollment and points
model ChallengeParticipant {
  id             String    @id @default(cuid())
  challengeId    String
  challenge      Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  memberId       String
  member         Member    @relation(fields: [memberId], references: [id], onDelete: Cascade)

  // Cached point totals (updated on each log/checkin for fast leaderboard queries)
  totalPoints    Int       @default(0)
  mealPoints     Int       @default(0)
  trainingPoints Int       @default(0)
  waterPoints    Int       @default(0)
  checkinPoints  Int       @default(0)
  streakPoints   Int       @default(0)

  // Streak tracking
  currentStreak  Int       @default(0)
  lastActiveDate DateTime?

  joinedAt       DateTime  @default(now())

  @@unique([challengeId, memberId])
  @@index([challengeId])
  @@index([memberId])
  @@index([challengeId, totalPoints])
  @@map("challenge_participants")
}

// Gym check-in records - tracks when members physically check in at the gym
// Used for challenge verification (training points only count with valid check-in)
model GymCheckin {
  id        String   @id @default(cuid())
  memberId  String
  member    Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  gymId     String
  gym       Gym      @relation(fields: [gymId], references: [id], onDelete: Cascade)
  date      DateTime @db.Date // Just the date, one check-in per day

  createdAt DateTime @default(now())

  @@unique([memberId, date]) // One check-in per member per day
  @@index([memberId])
  @@index([gymId])
  @@index([memberId, date])
  @@map("gym_checkins")
}

// Session scheduling request - supports back-and-forth counter-proposals
// Either coach or member can initiate a session request
model SessionRequest {
  id        String   @id @default(cuid())
  staffId   String
  memberId  String

  // Session details (current proposal)
  sessionType String   // "training" | "consultation" | "checkin"
  proposedAt  DateTime // Proposed date/time for the session
  duration    Int      // Duration in minutes: 30 | 45 | 60 | 90
  location    String   // "gym" | "virtual"
  note        String?  @db.Text // Optional message with the request

  // Request tracking
  initiatedBy  String   // "coach" | "member" - who created this request
  status       String   @default("pending") // "pending" | "countered" | "accepted" | "declined"
  counterCount Int      @default(0) // How many counter-proposals have been made
  lastActionBy String?  // "coach" | "member" - who last acted on this request
  lastActionAt DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  staff  Staff  @relation(fields: [staffId], references: [id], onDelete: Cascade)
  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade)

  // Proposal history for audit trail
  proposalHistory SessionProposal[]

  @@index([staffId])
  @@index([memberId])
  @@index([status])
  @@index([staffId, status])
  @@index([memberId, status])
  @@map("session_requests")
}

// Tracks the history of proposals and counter-proposals for a session request
model SessionProposal {
  id               String         @id @default(cuid())
  sessionRequestId String
  sessionRequest   SessionRequest @relation(fields: [sessionRequestId], references: [id], onDelete: Cascade)

  proposedBy String   // "coach" | "member"
  proposedAt DateTime // The proposed date/time
  duration   Int      // Duration in minutes
  location   String   // "gym" | "virtual"
  note       String?  @db.Text

  // Response to this proposal
  response   String?   // "accepted" | "declined" | "countered" | null (pending)
  responseAt DateTime?

  createdAt DateTime @default(now())

  @@index([sessionRequestId])
  @@map("session_proposals")
}

// Confirmed scheduled sessions (created when a SessionRequest is accepted)
model ScheduledSession {
  id       String @id @default(cuid())
  staffId  String
  memberId String

  // Session details (copied from accepted proposal)
  sessionType String   // "training" | "consultation" | "checkin"
  scheduledAt DateTime // Confirmed date/time
  duration    Int      // Duration in minutes
  location    String   // "gym" | "virtual"
  note        String?  @db.Text

  // Original request reference
  originalRequestId String?

  // Status
  status String @default("confirmed") // "confirmed" | "completed" | "cancelled"

  // Cancellation info (required when cancelling)
  cancelledAt        DateTime?
  cancelledBy        String?   // "coach" | "member"
  cancellationReason String?   @db.Text

  // Completion
  completedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  staff  Staff  @relation(fields: [staffId], references: [id], onDelete: Cascade)
  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([staffId])
  @@index([memberId])
  @@index([scheduledAt])
  @@index([status])
  @@index([staffId, status, scheduledAt])
  @@index([memberId, status, scheduledAt])
  @@map("scheduled_sessions")
}

// Challenge winner history - tracks past winners for exclusion from future challenges
model ChallengeWinner {
  id          String   @id @default(cuid())
  challengeId String
  memberId    String
  rank        Int      // Final rank (1, 2, 3, etc.)
  totalPoints Int      // Points at time of win
  wonAt       DateTime @default(now())

  challenge   Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  member      Member    @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([challengeId, memberId])
  @@index([memberId])
  @@index([memberId, wonAt])
  @@map("challenge_winners")
}
